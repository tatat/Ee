(function(e){e([],function(){"use strict";var e=Array.prototype.indexOf?function(e,t){return e.indexOf(t)}:function(e,t){var n=e.length,r=Number(t)||0;r=r<0?Math.ceil(r):Math.floor(r),r<0&&(r+=n);for(;r<n;r++)if(r in e&&e[r]===t)return r;return-1},t=Array.prototype.forEach?function(e,t,n){e.forEach(t,n)}:function(e,t,n){for(var r=0,i=e.length;r<i;r++)r in e&&t.call(n,e[r],r,e)},n=Array.prototype.slice,r=Object.prototype.toString,i=typeof process!="undefined"&&typeof process.nextTick=="function"?function(e){process.nextTick(e)}:function(e){setTimeout(e,0)},s=Array.isArray?function(e){return Array.isArray(e)}:function(e){return r.call(e)==="[object Array]"},o=function(e){return r.call(e)==="[object Object]"},u=function(){},a=function(e,t){e&&typeof e!="function"&&(t=e,e=null),this.__events={},this.__emitted={},this.__until={},this.__listeners=null,t=t||{},this.new_listener=!!t.new_listener,t.data_store&&a.DataStore.call(this),!e&&t.Event&&(e=t.Event);if(e&&e.prototype instanceof a.Event)this.Event=e;else if(!this.Event||!(this.Event.prototype instanceof a.Event))this.Event=a.Event};a.prototype.reserve=function(e){s(e)||(e=[e]);var t=this.__events;for(var n=0,r=e.length;n<r;n++)t.hasOwnProperty(e[n])||(t[e[n]]=[]),t[e[n]].reserved=!0;return this},a.prototype.unreserve=function(e){s(e)||(e=[e]);var t=this.__events;for(var n=0,r=e.length;n<r;n++)t.hasOwnProperty(e[n])&&(t[e[n]].length?delete t[e[n]].reserved:delete t[e[n]]);return this},a.prototype.lookup=function(e,n,r){typeof e=="function"&&(r=n,n=e,e=null);var i=this.__events,s=[];e instanceof RegExp||(e==null&&(e=""),e=new RegExp(e));for(var o in i)i.hasOwnProperty(o)&&e.test(o)&&s.push(o);return n?(t(s,n,this),r?this:s):s},a.prototype.on=function(e,t,n,r,i){s(e)||(e=[e]),s(t)||(t=[t]),n=n==null?-1:n-0||0;var o=this.__events,u=this.new_listener,a=r?"unshift":"push",f=t.length,l,c,h,p=[];for(var d=0,v=e.length,m;d<v;d++){l=e[d],o[l]||(o[l]=[]);for(m=0;m<f;m++)c=t[m],h={type:l,listener:c,times:n},o[l][a](h),p.push(h),u&&this.emit("newListener",l,c,n,r)}if(i!=null){s(i)||(i=[i]);var g=this.__until,y;for(d=0,v=i.length;d<v;d++)y=i[d],g[y]||(g[y]=[]),g[y].push.apply(g[y],p)}return this.__listeners=p,this},a.prototype.once=function(e,t,n,r){return this.on(e,t,1,n,r)},a.prototype.first=function(e,t,n,r){return this.on(e,t,n,!0,r)},a.prototype.until=function(e,t,n,r,i){return this.on(t,n,r,i,e)},a.prototype.until_once=function(e,t,n,r){return this.on(t,n,1,r,e)},a.prototype.until_mutually=function(e,t,n,r,i){if(o(e)){var u=e;e=u.event||u.events,t=u.listener||u.listeners,r=u.times,i=u.first,n=u.until}s(n)||(n=n==null?[]:[n]);for(var a=0,f=e.length,l,c,h;a<f;a++){for(h=n.slice(),l=e[a],c=0;c<f;c++)l!==e[c]&&h.push(e[c]);h.length&&this.on(l,t,r,i,h)}return this},a.prototype.until_once_mutually=function(e,t,n,r){return o(e)&&(e.times=1),this.until_mutually(e,t,n,1,r)},a.prototype.within=function(e,t,n,r,i,s,o){if(e&&typeof e=="object"){var u=e;e=u.within,t=u.event||u.events,n=u.listener||u.listeners,r=u.callback,i=u.times,s=u.first,o=u.until}var a=this,f=this.on(t,n,i,s,o).__listeners;return setTimeout(function(){a.off(t,f),r&&r.call(a,f)},e-0||0),this},a.prototype.within_once=function(e,t,n,r,i,s){return e&&typeof e=="object"&&(e.times=1),this.within(e,t,n,r,1,i,s)},a.prototype.off=function(t,n){var r,i;if(s(t)){for(r=0,i=t.length;r<i;r++)this.off(t[r],n);return this}if(s(n)){for(r=0,i=n.length;r<i;r++)this.off(t,n[r]);return this}var o=this.__events,u=this.__emitted,a;if(!o[t])return this;if(n==null)return o[t].reserved?o[t].length=0:delete o[t],this;if(typeof n=="function"){a=-1;for(var f=o[t],r=0,i=f.length;r<i;r++)if(f[r].listener===n){a=r;break}}else a=e(o[t],n);return a!==-1&&(o[t].splice(a,1),o[t].length===0&&!o[t].reserved&&delete o[t]),this},a.prototype.size=function(e){return this.listeners(e,!0).length},a.prototype.ever=function(e){if(e==null){var t=this.__emitted,n=0;for(var r in t)t[r]!=null&&(n+=t[r]);return n}return this.__emitted[e]||0},a.prototype.listeners=function(e,t){var n=this.__events,r,i,s,o;if(e==null){r=[];for(i in n)for(s=0,o=n[i].length;s<o;s++)r.push(n[i][s])}else r=(n[e]||[]).slice();if(!t)for(s=0,o=r.length;s<o;s++)r[s]=r[s].listener;return r},a.prototype.__trigger=function(e,t,n){var r,i=this.__events,s=this.__emitted,o=this.__until,u;this.__listeners=null,e instanceof a.Event?(r=e,e=r.type):r=new this.Event(e),s[e]==null&&(s[e]=0),s[e]++;if(o[e]){for(var f=o[e],l=0,c=f.length;l<c;l++)this.off(f[l].type,f[l]);delete o[e]}if(!i[e]){if(e==="error")throw t[0]?t[0]instanceof Error?t[0]:new Error(t[0]):new Error("Uncaught, unspecified 'error' event.");u=[]}else u=i[e].slice();return t.unshift(r),n.call(this,e,r,u,t),this},a.prototype.emit=function(e){return this.__trigger(e,n.call(arguments,1),function(e,t,n,r){t.abortable=!0;for(var i,s=0,o=n.length;s<o&&!t.aborted;s++)t.position=s,i=n[s],i.times!==-1&&--i.times===0&&this.off(e,i),i.listener.apply(this,r)})};var f=function(e,t,n,r,i,s){r.times!==-1&&--r.times===0&&e.off(t,r),s?s.length>3?s.call(e,r,n,i,function(){r.listener.apply(e,i)}):(s.call(e,r,n,i),r.listener.apply(e,i)):r.listener.apply(e,i)};return a.prototype.chain=function(e,t,n,r){return typeof t=="function"&&(r=n,n=t,t=[]),this.__trigger(e,t||[],function(e,t,i,s){var o=this,u;t.abortable=!0,t.preventable=!0,t.position=-1;if(i.length===0)return n&&n.call(o,t);(function a(){if(t.aborted||t.prevented||!(u=i.shift()))return n&&n.call(o,t);t.position++,t.__next=a,f(o,e,t,u,s,r)}).call(t)})},a.prototype.parallel=function(e,n,r,s){return typeof n=="function"&&(s=r,r=n,n=[]),this.__trigger(e,n||[],function(e,n,o,u){var a=this;n.__complete=function(){r&&r.call(a,n)},n.preventable=!0,n.undone=o.length;if(o.length===0)return i(n.__complete);t(o,function(t){i(function(){f(a,e,n,t,u,s)})})})},a.prototype.Event=null,a.DataStore=function(){this.get=function(e,t){return this.data?this.data.hasOwnProperty(e)?this.data[e]:t:t},this.set=function(e,t){return this.data||(this.data={}),this.data[e]=t,this},this.unset=function(e){return this.data&&delete this.data[e],this}},a.Event=function(e){this.type=e,this.abortable=!1,this.aborted=!1,this.prevented=!1,this.preventable=!1,this.position=null,this.undone=null,this.__next=null,this.__complete=null},a.Event.prototype=new a.DataStore,a.Event.prototype.stop=function(){return this.abortable&&(this.aborted=!0),this.preventable&&(this.prevented=!0),this.abortable||this.prevented?this.next():this},a.Event.prototype.abort=function(){return this.abortable&&(this.aborted=!0,this.next()),this},a.Event.prototype.prevent=function(){return this.preventable&&(this.prevented=!0,this.next()),this},a.Event.prototype.next=function(){if(this.__next){var e=this.__next;this.__next=null,e.call(this)}return this},a.Event.prototype.done=function(){if(this.__complete&&--this.undone<=0){var e=this.__complete;this.__complete=null,e.call(this)}return this},a})})(typeof define!="undefined"?define:typeof module!="undefined"?function(e,t){module.exports=t()}:function(e,t){this.Ee=t()});